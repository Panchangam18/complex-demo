#!/opt/puppetlabs/puppet/bin/ruby
# Puppet External Node Classifier
# Generated by Ansible Tower for Puppet Enterprise
# Architecture Plan: External node classification using Hiera data

require 'yaml'

node_name = ARGV[0]
hiera_dir = '/etc/puppetlabs/code/environments/production/data/nodes'
node_file = "#{hiera_dir}/#{node_name}.yaml"

# Default node configuration
node_config = {
  'classes' => ['base::system'],
  'parameters' => {},
  'environment' => 'production'
}

# Load node-specific configuration if available
if File.exist?(node_file)
  begin
    hiera_data = YAML.load_file(node_file)
    
    # Extract classes from Hiera data
    if hiera_data['classes']
      node_config['classes'] = hiera_data['classes']
    end
    
    # Extract parameters (all other data becomes parameters)
    hiera_data.each do |key, value|
      next if key == 'classes'
      node_config['parameters'][key] = value
    end
    
    # Set environment if specified
    if hiera_data['node_metadata'] && hiera_data['node_metadata']['environment']
      node_config['environment'] = hiera_data['node_metadata']['environment']
    end
    
  rescue => e
    # Log error but continue with defaults
    STDERR.puts "Error loading node data for #{node_name}: #{e.message}"
  end
end

# Output YAML for Puppet
puts node_config.to_yaml 