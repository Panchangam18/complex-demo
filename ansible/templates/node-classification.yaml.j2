---
# Node Classification for {{ item }}
# Generated by Ansible Tower for Puppet Enterprise consumption
# Architecture Plan: "Tower writes a classification Hiera file consumed by Puppet for ongoing policy"

# Node metadata
node_metadata:
  hostname: "{{ item }}"
  fqdn: "{{ item }}.{{ hostvars[item]['ansible_domain'] | default('local') }}"
  environment: "{{ hostvars[item]['environment'] | default('dev') }}"
  cloud_provider: "{{ hostvars[item]['cloud_provider'] | default('unknown') }}"
  provisioned_by: "ansible-tower"
  provisioned_at: "{{ ansible_date_time.iso8601 }}"

# Puppet classes and configuration
classes:
{% if hostvars[item]['service_type'] is defined %}
  - "{{ hostvars[item]['service_type'] | replace('-', '_') }}"
{% endif %}
{% if hostvars[item]['consul_role'] is defined %}
  - "consul::{{ hostvars[item]['consul_role'] }}"
{% endif %}
  - "base::system"
  - "base::monitoring"
  - "base::security"
{% if hostvars[item]['day_2_ops'] | default(false) %}
  - "puppet::agent"
{% endif %}

# Service-specific configuration
{% if hostvars[item]['service_type'] == 'jenkins' %}
jenkins:
  version: "latest"
  admin_user: "admin"
  plugins:
    - "git"
    - "workflow-aggregator"
    - "blue-ocean"
    - "prometheus"
  nexus_integration:
    enabled: true
    url: "{{ hostvars[item]['nexus_url'] | default('') }}"
  consul_registration: true

{% elif hostvars[item]['service_type'] == 'consul' %}
consul:
  datacenter: "{{ hostvars[item]['consul_datacenter'] | default('aws-dev-us-east-2') }}"
  role: "{{ hostvars[item]['consul_role'] | default('agent') }}"
  encrypt_key: "{{ consul_gossip_key | default('') }}"
  connect_enabled: true
  ui_enabled: {{ 'true' if hostvars[item]['consul_role'] == 'server' else 'false' }}
  acl_enabled: false

{% elif hostvars[item]['service_type'] == 'puppet-enterprise' %}
puppet_enterprise:
  role: "{{ hostvars[item]['puppet_role'] | default('agent') }}"
  console_admin_password_managed: true
  code_manager_enabled: true
  r10k_remote: "https://github.com/puppetlabs/control-repo.git"
  autosign_enabled: true

{% endif %}

# Base system configuration
base:
  packages:
    - "curl"
    - "wget"
    - "git"
    - "vim"
    - "htop"
    - "nc"
    - "jq"
  services:
    - "chronyd"
    - "rsyslog"
    - "firewalld"
  firewall:
    enabled: true
    default_zone: "public"
  
  # Security hardening
  security:
    selinux: "enforcing"
    fail2ban: true
    automated_updates: false  # Managed by Puppet
    ssh_hardening: true
  
  # Monitoring configuration
  monitoring:
    node_exporter:
      enabled: true
      port: 9100
    prometheus_exporters:
{% if hostvars[item]['service_type'] == 'jenkins' %}
      - "jenkins"
{% elif hostvars[item]['service_type'] == 'consul' %}
      - "consul"
{% elif hostvars[item]['service_type'] == 'puppet-enterprise' %}
      - "puppetserver"
      - "puppetdb"
{% endif %}

# Consul service registration
{% if hostvars[item]['consul_service_name'] is defined %}
consul_services:
  "{{ hostvars[item]['consul_service_name'] }}":
    port: {{ hostvars[item]['consul_service_port'] | default(80) }}
    tags:
      - "{{ hostvars[item]['service_type'] | default('service') }}"
      - "{{ hostvars[item]['environment'] | default('dev') }}"
      - "{{ hostvars[item]['cloud_provider'] | default('unknown') }}"
    check:
      http: "http://{{ hostvars[item]['ansible_host'] }}:{{ hostvars[item]['consul_service_port'] | default(80) }}/health"
      interval: "30s"
      timeout: "10s"
{% endif %}

# Puppet agent configuration
puppet:
  agent:
    enabled: {{ hostvars[item]['day_2_ops'] | default(false) | lower }}
    server: "{{ puppet_server_ip | default('') }}"
    environment: "{{ hostvars[item]['puppet_environment'] | default('production') }}"
    runinterval: 1800
    splay: true
    splaylimit: 300
  
  reports:
    enabled: true
    server: "{{ puppet_server_ip | default('') }}"
    format: "json"
    
# Logging configuration for centralized log management
logging:
  rsyslog:
    remote_server: "{{ elasticsearch_endpoint | default('') }}"
    facility: "local0"
    severity: "info"
  
  # Application-specific log forwarding
{% if hostvars[item]['service_type'] == 'jenkins' %}
  jenkins:
    log_level: "INFO"
    log_rotation: "weekly"
    log_retention: "4"
{% elif hostvars[item]['service_type'] == 'consul' %}
  consul:
    log_level: "INFO"
    log_rotate_duration: "24h"
    log_rotate_max_files: 5
{% endif %}

# Environment-specific overrides
{% if hostvars[item]['environment'] == 'prod' %}
security:
  selinux: "enforcing"
  fail2ban: true
  automated_updates: false
  ssh_hardening: true
  audit_logging: true

monitoring:
  collection_interval: "15s"
  retention_period: "30d"
  alerting_enabled: true

{% elif hostvars[item]['environment'] == 'dev' %}
security:
  selinux: "permissive"
  fail2ban: false
  automated_updates: true
  ssh_hardening: false
  audit_logging: false

monitoring:
  collection_interval: "30s"
  retention_period: "7d"
  alerting_enabled: false
{% endif %} 